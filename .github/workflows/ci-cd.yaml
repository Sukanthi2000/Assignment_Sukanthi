name: Flask CI/CD

on:
  push:
    branches:
      - main  # Runs workflow when code is pushed to main

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest  # Workflow runs on a Linux VM

    steps:
      # 1. Checkout your code
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      # 3. Install dependencies
      - name: Install dependencies
        run: |
          cd Assignment_3
          ls -R
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      # 4. Run tests (if any)
      - name: Run tests
        run: |
          echo "No tests yet. Placeholder"

      # 5. Build Docker image
      - name: Build Docker image
        run: docker build -t flask-k8s-demo:latest ./Assignment_3

      - name: Docker existing images
        run: |
          docker version
          docker images

      # 6. (Optional) Push Docker image to Docker Hub
      - name: Docker Login
        run: echo ${{ secrets.DOCKER_PASSWORD }} | docker login -u ${{ secrets.DOCKER_USERNAME }} --password-stdin

      - name: Push image
        run: |
          docker tag flask-k8s-demo:latest ${{ secrets.DOCKER_USERNAME }}/flask-k8s-demo:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/flask-k8s-demo:latest

      # 7. Deploy to Kind
      - name: Install Kind
        run: |
          curl -Lo ./kind https://kind.sigs.k8s.io/dl/v0.20.0/kind-linux-amd64
          chmod +x ./kind
          sudo mv ./kind /usr/local/bin/kind

      - name: Create Kind cluster
        run: |
           kind create cluster --name my-cluster

      - name: Wait for Kind to be ready
        run: |
           sleep 30
           kubectl wait --for=condition=Ready node/my-cluster-control-plane --timeout=60s
           kind get clusters

      - name: Set kubeconfig
        run: kind get kubeconfig --name my-cluster > ~/.kube/config

      - name: Load Docker image into Kind
        run: kind load docker-image flask-k8s-demo:latest --name my-cluster


      - name: Deploy to Kind
        run: |
          kubectl apply -f Assignment_3/deployment.yaml
          kubectl apply -f Assignment_3/Service.yaml

      - name: Debug pod status
        run: |
          kubectl get nodes
          kubectl get pods  
          kubectl describe pods -l app=flask-app || true
          kubectl logs -l app=flask-app || true
  

      # 8. Wait for pods to be running and show deployments, pods, and services
      - name: Wait for pods and show resources
        run: |
          kubectl wait --for=condition=Ready pod -l app=flask-app --timeout=120s
          kubectl get deployments
          kubectl get pods
          kubectl get svc

      - name: Test Flask app via NodePort
        run: |
           NODE_IP=$(docker inspect -f '{{range .NetworkSettings.Networks}}{{.IPAddress}}{{end}}' my-cluster-control-plane)
           sleep 5
           curl --fail http://$NODE_IP:30080 || (echo "App not responding" && exit 1)

